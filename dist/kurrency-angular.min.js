"use strict";!function(a,b){function c(){angular.module("kurrency",[]).constant("kurrencyConfig",{cache:!1,local:!1,accessToken:"ABC123",mode:"test",phrases:{cart_empty:"You don't have anything in your cart"}}).factory("kurrency",["$rootScope","$http","kurrencyConfig",function(a,b,c){function d(c,d){var e=this;if(e.options={},!c)return console.log("Missing Kurrency object");var f={type:"get",url:"",path:"",baseUrl:c.options.baseUrl||"",data:{},dataType:"json",headers:{"Access-Token":c.options.accessToken,"Authentication-Key":c.options.authenticationKey?c.options.authenticationKey:void 0,"Session-Id":c.options.session?c.options.session._id:void 0,"Kurrency-Mode":c.options.mode?c.options.mode:"test"},commonError:function(a){console.log(a)}};return e.config=function(a){return e.options=angular.extend({},f,a),e},e.req=function(c,d,f,g){a.apiLoading=!0;var h=angular.extend({},e.options);h.method=c,h.url=d,"post"===c||"put"===c?(h.data=JSON.stringify(f),h.contentType="application/json"):h.params=f;var i=b(h);return i.success(function(){a.$broadcast("apiFinished",!0)}),i.error(function(b){return a.$broadcast("apiFinished",!0),g?g(b):void a.$broadcast("apiError",b)}),i},e.get=function(a,b,c){return"function"==typeof b&&(c=b,b=null),e.req("get",a,b,c)},e.post=function(a,b,c){return"function"==typeof b&&(c=b,b=null),e.req("post",a,b,c)},e.put=function(a,b,c){return"function"==typeof b&&(c=b,b=null),e.req("put",a,b,c)},e.del=function(a,b,c){return"function"==typeof b&&(c=b,b=null),e.req("delete",a,b,c)},e.config(d)}function e(){var a=this;return"undefined"!=typeof Storage?(a.set=function(a,b){return"object"!=typeof b?(sessionStorage[a]=b,sessionStorage[a]):(sessionStorage[a]=JSON.stringify(b),sessionStorage[a])},a.get=function(a){var b;try{b=JSON.parse(sessionStorage[a])}catch(c){b=sessionStorage[a]}return b},a.remove=function(a){return delete sessionStorage[a],null}):(a.set=function(a,b){var c="",d="object"==typeof b?JSON.stringify(b):escape(b);document.cookie=escape(a)+"="+d+c+"; path=/"},a.get=function(a){for(var b=escape(a)+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "===e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(b)){var f;try{f=JSON.parse(e.substring(b.length,e.length))}catch(g){f=decodeURIComponent(e.substring(b.length,e.length))}return f}}return null},a.remove=function(b){a.create(b,"",-1)}),a}var f=function(a){function b(a){a&&r.config(a)}function c(a){a&&r.config(a)}function f(a){a&&r.config(a)}function g(a){a&&r.config(a)}function h(a){a&&r.config(a)}function i(a){a&&r.config(a)}function j(a){a&&r.config(a)}function k(a){a&&r.config(a)}function l(a){a&&r.config(a)}function m(a){var b=this;return b.rate=null,b.ship_to={name:void 0,company_name:void 0,attention_to:void 0,email:void 0,phone:void 0,address:{address_1:void 0,address_2:void 0,address_3:void 0,city:void 0,postal_code:void 0,state_code:void 0,country_code:"US"}},b.setRate=function(a){return b.rate=a,b},b.setShipTo=function(a){return b.ship_to.name=a.name,b.ship_to.company_name=a.company_name,b.ship_to.attention_to=a.attention_to,b.ship_to.email=a.email,b.ship_to.phone=a.phone,a.address&&(b.ship_to.address=a.address),b},b.setAddress=function(a){b.ship_to.address=a},b=angular.extend(b,a)}function n(a){var b=this;return b._id=void 0,b.ship_to={name:void 0,company_name:void 0,attention_to:void 0,email:void 0,phone:void 0,address:{address_1:void 0,address_2:void 0,address_3:void 0,city:void 0,postal_code:void 0,state_code:void 0,country_code:"US"}},b.setShipTo=function(a){return b.ship_to.name=a.name,b.ship_to.company_name=a.company_name,b.ship_to.attention_to=a.attention_to,b.ship_to.email=a.email,b.ship_to.phone=a.phone,a.address&&(b.ship_to.address=a.address),b},b.setAddress=function(a){b.ship_to.address=a},b=angular.extend(b,a)}function o(a){var b=this;return b.type="credit_card",b.card={},b.bank_account={},b=angular.extend(b,a)}function p(a){var b=new o({type:"credit_card"});return b._id=void 0,b.card.name=void 0,b.card.card_number=void 0,b.card.expiration_month=(new Date).getMonth()+1,b.card.expiration_year=(new Date).getFullYear(),b.card.security_code=void 0,b.card.postal_code=void 0,b=angular.extend(b,a)}function q(a){var b=new o({type:"bank_account"});return b._id=void 0,b.bank_account.name=void 0,b.bank_account.account_number=void 0,b.bank_account.routing_number=void 0,b.bank_account.type="checking",b=angular.extend(b,a)}var r=this;r.options={},r.Stor=e,r.Request=d;var s=new r.Stor,t={test:"http://0.0.0.0:3458/jsapi",production:"https://api.kurrency.io/api/jsapi"},u={products:{},product_lines:{}};if(!window.angular)throw Error("angular is missing");var v={caching:!0,local:!1,accessToken:"",authenticationKey:null,session:null,mode:"test",baseUrl:t[this.local?"test":"production"]};return r.config=function(a){return r.options=angular.extend(v,a),r.options.baseUrl=r.options.local?t.test:t.production,r},r.handleError=function(a){a&&403===a.responseCode&&(s.remove("session"),r.options.session=null)},b.prototype.get=function(a){if(!a)return r.options.session;if(r.options.session=s.get("session"),r.options.session)return a(null,r.options.session);var b=new d(r).get(r.options.baseUrl+"/session",null,r.handleError);b.success(function(b){return r.options.session=b.pkg.data,s.set("session",r.options.session),a(null,r.options.session)})},b.prototype.save=function(a,b){r.options.session=a;var c=new d(r).post(r.options.baseUrl+"/session",a.data,r.handleError);c.success(function(a){return r.options.session=a.pkg.data,s.set("session",r.options.session),b(null,r.options.session)})},c.prototype.get=function(a){r.session.get(function(b,c){c.data.cart||(c.data.cart=[]),r.session.save(c,function(b,c){return a(null,c.data.cart)})})},c.prototype.add=function(a,b,c){r.cart.get(function(d,e){for(var f=0;f<e.length;f++)if(e[f]._id===a._id)return e[f].qty+=parseInt(b),r.session.get(function(a,b){b.data.cart=e,r.session.save(b,function(){return c(null,e)})});e.push({_id:a._id,name:a.name,sub_title:a.sub_title,qty:parseInt(b),image:a.images[0],weight:a.weight,dimensions:a.dimensions,price:a.price,product_lines:a.product_lines}),r.session.get(function(a,b){b.data.cart=e,r.session.save(b,function(){return c(null,e)})})})},c.prototype.update=function(a,b,c){r.cart.get(function(d,e){for(var f=0;f<e.length;f++)if(e[f]._id===a._id){e[f].qty=parseInt(b);break}r.session.get(function(a,b){b.data.cart=e,r.session.save(b,function(){return c(null,e)})})})},c.prototype.remove=function(a,b){r.cart.get(function(c,d){for(var e=0;e<d.length;e++)if(d[e]._id===a._id){d.splice(e,1);break}r.session.get(function(a,c){c.data.cart=d,r.session.save(c,function(){return b(null,d)})})})},c.prototype.empty=function(a){r.session.get(function(b,c){c.data.cart=[],r.session.save(c,function(){return a(null,[])})})},c.prototype.replace=function(a,b){r.session.get(function(c,d){d.data.cart=a,r.session.save(d,function(a,c){return a?b(a,null):b(null,c.data.cart)})})},f.prototype.register=function(){},f.prototype.login=function(a,b,c){var e=new d(r).post(r.options.baseUrl+"/login",{username:a,password:b},r.handleError);e.success(function(a){return s.set("user",a.pkg.data),c(null,a.pkg.data)})},g.prototype.list=function(a){var b=new d(r).get(r.options.baseUrl+"/addresses",null,r.handleError);b.success(function(b){return a(null,b.pkg.data)})},g.prototype.create=function(a,b){var c=new d(r).post(r.options.baseUrl+"/addresses",a,r.handleError);c.success(function(a){return b(null,a.pkg.data)})},g.prototype.edit=function(a,b){var c=new d(r).put(r.options.baseUrl+"/addresses",a,r.handleError);c.success(function(a){return b(null,a.pkg.data)})},g.prototype.remove=function(a,b){var c=new d(r).del(r.options.baseUrl+"/addresses",a,r.handleError);c.success(function(a){return b(null,a.pkg.data)})},h.prototype.list=function(a){var b=new d(r).get(r.options.baseUrl+"/payment_methods",null,r.handleError);b.success(function(b){return a(null,b.pkg.data)})},h.prototype.create=function(a,b){var c=new d(r).post(r.options.baseUrl+"/payment_methods",a,r.handleError);c.success(function(a){return b(null,a.pkg.data)})},h.prototype.edit=function(a,b){var c=new d(r).put(r.options.baseUrl+"/payment_methods",a,r.handleError);c.success(function(a){return b(null,a.pkg.data)})},h.prototype.remove=function(a,b){var c=new d(r).del(r.options.baseUrl+"/payment_methods",a,r.handleError);c.success(function(a){return b(null,a.pkg.data)})},i.prototype.list=function(a,b){var c=JSON.stringify(a);if(u.products[c])return b(null,u.products[c]);var e=new d(r).get(r.options.baseUrl+"/products",a,r.handleError);e.success(function(a){return r.options.caching===!0&&(u.products[c]=a.pkg.data),b(null,a.pkg.data)})},j.prototype.list=function(a,b){var c=JSON.stringify(a);if(u.product_lines[c])return b(null,u.product_lines[c]);var e=new d(r).get(r.options.baseUrl+"/product-lines",a,r.handleError);e.success(function(a){return r.options.caching===!0&&(u.product_lines[c]=a.pkg.data),b(null,a.pkg.data)})},k.prototype.list=function(a,b){var c=new d(r).get(r.options.baseUrl+"/orders",a,r.handleError);c.success(function(a){return b(null,a.pkg.data)})},k.prototype.create=function(a,b){var c=new d(r).post(r.options.baseUrl+"/orders",a,r.handleError);c.success(function(a){return b(null,a.pkg.data)})},k.prototype.taxes=function(a,b,c){var e={value:a,ship_to:b.ship_to};r.session.get(function(a){if(a)return c(a,null);var b=new d(r).post(r.options.baseUrl+"/orders/taxes",e,r.handleError);b.success(function(a){return c(null,a.pkg.data)})})},l.prototype.rates=function(a,b){if(!a.products)return b(new Error("Missing products"),null);var c=angular.copy(a);delete c.products,c.packages=[{weight:0,price:0}];for(var e=0;e<a.products.length;e++)c.packages[0].weight+=a.products[e].weight*a.products[e].qty,c.packages[0].price+=a.products[e].price*a.products[e].qty;var f=new d(r).post(r.options.baseUrl+"/shipping/rates",c,r.handleError);f.success(function(a){var c=a.pkg.data;return c.sort(function(a,b){return a.cost-b.cost}),b(null,c)})},r.session=new b,r.cart=new c,r.auth=new f,r.addresses=new g,r.payment_methods=new h,r.products=new i,r.product_lines=new j,r.orders=new k,r.shipping=new l,r.shipment=m,r.customer=n,r.credit_card=p,r.bank_account=q,r.config(a)};return new f(c)}]).directive("kurrencyMenu",function(a,b){return{restrict:"E",templateUrl:function(a,b){var c="/kurrency-templates/kurrency-menu.html";return b.templateUrl&&(c=b.templateUrl),c},replace:!0,link:function(c){c.config=b,c.cart=null,a.cart.get(function(a,b){c.cart=b})}}}),a.KURRENCY_CONFIG&&(a.KURRENCY_CONFIG.integrated||angular.injector(["ng","kurrency"]).invoke(["$compile","$rootScope","kurrencyConfig",function(c,d,e){e.cache=a.KURRENCY_CONFIG.CACHE?a.KURRENCY_CONFIG.CACHE:!0,e.accessToken=a.KURRENCY_CONFIG.ACCESS_TOKEN,e.mode=a.KURRENCY_CONFIG.MODE?a.KURRENCY_CONFIG.MODE:"test",e.local=a.KURRENCY_CONFIG.LOCAL?a.KURRENCY_CONFIG.LOCAL:!1,angular.element(b).find("body").append(c("<kurrency-menu></kurrency-menu>")(d))}])),a[KURRENCY_CONFIG.ANGULAR].module("kurrency").run(["$templateCache",function(a){a.put("kurrency-templates/kurrency-menu.html",'<div class="kurrency-menu">\n  <div class="kurrency-cart">\n    <a href ng-click="checkout()"><span class="kicon-cart"></span></a>\n    <p ng-if="cart.length == 0" ng-bind="config.phrases.cart_empty"></p>\n    <ul>\n      <li ng-repeat="item in cart"></li>\n    </ul>\n  </div>\n  <div class="kurrency-actions">\n    <a href ng-click="account()"><span class="kicon-user"></span></a>\n  </div>\n</div>')}])}if(a.KURRENCY_CONFIG?a.KURRENCY_CONFIG.ANGULAR||(a.KURRENCY_CONFIG.ANGULAR="angular"):a.KURRENCY_CONFIG={ANGULAR:"angular"},a[KURRENCY_CONFIG.ANGULAR]||"undefined"!=typeof a.KURRENCY_CONFIG.REQUIRE_ANGULAR&&a.KURRENCY_CONFIG.REQUIRE_ANGULAR!==!0)c();else{var d=b.createElement("script");d.type="text/javascript",d.async=!0,d.src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.22/angular.min.js",b.getElementsByTagName("body")[0].appendChild(d),d.readyState?d.onreadystatechange=function(){("loaded"==script.readyState||"complete"==script.readyState)&&(script.onreadystatechange=null,c())}:d.onload=function(){c()}}}(window,document);